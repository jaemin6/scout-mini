## 🧭 로봇 좌표계에서의 오일러각과 쿼터니언

> **ROS2 Navigation / AMCL / RViz2 / YAML 좌표값 변환 정리**

---

### 📌 1. 오일러각(Euler Angle) 이란?

* 오일러각은 물체의 **회전 상태를 X, Y, Z축 기준으로 각각 몇 도 회전했는가**를 나타내는 방식이에요.
* 즉, **인간이 직관적으로 이해하기 쉬운 회전 표현법**입니다.
* ROS2에서 로봇의 **Yaw(요)**, 즉 “평면에서 어느 방향을 보고 있는가”를 표현할 때 주로 사용됩니다.

> 예시:
> θ = 0 → 동쪽(기준방향)
> θ = π/2 → 북쪽
> θ = -π/2 → 남쪽

---

### 📌 2. 쿼터니언(Quaternion) 이란?

* 쿼터니언은 **3차원 회전(Orientation)** 을 나타내기 위한 수학적 표현법이에요.
* 4개의 값 `(x, y, z, w)` 으로 구성되어 있으며, 각각의 의미는 다음과 같습니다:

| 구성요소        | 의미         | 설명                                                  |
| ----------- | ---------- | --------------------------------------------------- |
| **x, y, z** | 회전축의 방향 벡터 | 로봇이 회전할 **축의 방향**을 나타냅니다. (예: z축 중심으로 회전 시 (0,0,1)) |
| **w**       | 회전의 크기     | 회전축을 기준으로 **얼마나 회전했는지(각도)** 를 나타내는 값입니다.            |

> 쉽게 말해,
> 쿼터니언은 **“어느 축을 중심으로 얼마나 회전했는가”** 를 3D 공간에서 정확하게 표현하는 방법이에요.

* 오일러각은 **사람이 보기 편한 회전값(θ)**,
  쿼터니언은 **컴퓨터가 계산하기 좋은 회전값(x, y, z, w)** 이라고 볼 수 있습니다.

---

### 📌 3. 오일러각 ↔ 쿼터니언 변환 개념

#### ✅ 오일러각 → 쿼터니언

로봇이 **Z축 기준으로 회전하는 2D 평면**이라면 (roll=pitch=0):

$$
z = \sin(\frac{\theta}{2})\
w = \cos(\frac{\theta}{2})
$$

즉, 오일러각(θ)을 쿼터니언으로 바꾸면:

```python
orientation.z = math.sin(theta / 2)
orientation.w = math.cos(theta / 2)
```

---

#### ✅ 쿼터니언 → 오일러각

AMCL이나 TF에서 얻은 orientation 값이 쿼터니언이라면,
다시 오일러각(즉, 로봇이 바라보는 각도 θ)으로 변환할 수 있습니다.

$$
\theta = 2 \times \text{atan2}(z, w)
$$

즉, 파이썬 코드로는:

```python
theta = 2 * math.atan2(orientation.z, orientation.w)
```

---

### 📘 4. `atan2(z, w)` 의 의미

#### ⚙️ ① 단순 atan과의 차이

* `atan(y/x)` 는 단순히 **기울기 = y/x** 에 대한 각도만 구합니다.
  → 하지만 (x, y)가 어느 사분면에 있는지는 구분하지 못합니다.

* 반면 `atan2(y, x)` 는 **y와 x의 부호를 모두 고려**하여
  정확히 **-π ~ π** 범위의 각도를 구할 수 있습니다.

즉,
`atan2(y, x)` 는 “x축을 기준으로 (x, y) 벡터가 몇 라디안 회전했는가”를 알려주는 함수입니다.

---

#### ⚙️ ② 쿼터니언에서의 의미

쿼터니언은 이렇게 정의되어 있습니다:

$$
z = \sin(\frac{\theta}{2}), \quad w = \cos(\frac{\theta}{2})
$$

따라서,

$$
\frac{z}{w} = \tan(\frac{\theta}{2})
$$

이를 역으로 풀면,

$$
\frac{\theta}{2} = \text{atan2}(z, w)
$$

마지막으로 **실제 각도 θ를 구하기 위해 ×2를 곱해주는 것**이죠:

$$
\boxed{\theta = 2 \times \text{atan2}(z, w)}
$$

> 정리하면,
> `atan2(z, w)`는 **쿼터니언의 회전값을 오일러각으로 되돌리는 핵심 수식**입니다.

---

### 📘 5. θ(세타)의 기준

* ROS2에서 **θ = 0** 은 보통 **map 좌표계의 x축(+방향)**, 즉 “동쪽”을 의미합니다.
* θ가 **양수(+)로 증가하면 반시계 방향 회전**,
  즉 **북쪽 방향으로 회전**하는 걸 의미합니다.
* 이 기준은 **IMU의 자기센서(나침반)** 또는 **map frame 기준**에서 설정됩니다.

---

### 📁 6. YAML 파일 예시 (좌표 저장용)

```yaml
rooms:
  start:
    x: -0.09596
    y: -0.57000
    theta: 0.435
  home:
    x: 0.0176
    y: -0.5359
    theta: -3.014
  room501:
    x: 1.8712
    y: 1.2160
    theta: 0.287
  room502:
    x: 1.1140
    y: 3.1790
    theta: 1.8385
  room503:
    x: -0.1766
    y: 0.9095
    theta: -1.813
```

> ✅ **주의:** YAML에는 사람이 보기 좋은 오일러각(`theta`)으로 저장하지만,
> 실제 ROS2 코드 내에서는 이 값을 쿼터니언(`z, w`)으로 변환하여 퍼블리시합니다.

---

### 📘 7. 파이썬 변환 코드 예시

```python
import math
from geometry_msgs.msg import PoseStamped

pose = PoseStamped()
pose.pose.position.x = 1.2397
pose.pose.position.y = -10.1973

theta = 2 * math.atan2(-0.16823852364093989, 0.9857463158252822)  # z, w → θ

# 다시 오일러각 → 쿼터니언
pose.pose.orientation.z = math.sin(theta / 2)
pose.pose.orientation.w = math.cos(theta / 2)

print("theta (radian):", theta)
```

---

### 🧩 8. 요약 정리

| 구분                | 표현 방식               | 장점             | ROS2에서 사용 위치            |
| ----------------- | ------------------- | -------------- | ----------------------- |
| 오일러각 (θ)          | 직관적 (라디안 각도)        | 사람이 이해하기 쉬움    | YAML, 로봇 위치 저장          |
| 쿼터니언 (x, y, z, w) | 수학적으로 안정적           | 컴퓨터 계산에 적합     | AMCL, TF, PoseStamped 등 |
| 변환식               | θ = 2 × atan2(z, w) | z, w로부터 회전각 복원 | 코드 내부 변환                |

---

📄 **결론**

> * YAML에는 사람이 읽기 쉬운 오일러각(θ)을 저장하고,
> * ROS2에서는 쿼터니언(z, w)으로 변환해 사용한다.
> * 변환 공식은
>   **θ = 2 × atan2(z, w)**
>   **z = sin(θ/2)**
>   **w = cos(θ/2)**
> * `atan2()`는 사분면 정보를 포함한 정확한 각도 계산 함수이다.
